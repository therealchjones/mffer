<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script
	src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
	integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
	crossorigin="anonymous"
></script>
<script
	src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
	integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
	crossorigin="anonymous"
></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
	integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
	crossorigin="anonymous"
></script>
<!-- Local JavaScript -->
<script>
	"use strict";
	class Job {
		constructor(param) {
			let jobNumber = Math.floor(Math.random() * 10000);
		}
	}
	class JobQueue {}

	// The only global variable (in this script), obtained at start time from
	// Google Sheets and not changed (though may be reloaded from Sheets).
	var shadowlandDatabase;

	$(document).ready(function () {
		initializePage();
	});

	function initializePage() {
		// This may also be used for re-initializing the page programmatically
		// rather than hard-reloading; don't assume that settings are always
		// as written in the starting HTML, and zero/reload globals.
		$("#content-shadowland").hide();
		$("#content-loading").show();

		let loadDataNumber = markProgress("Loading database");
		google.script.run
			.withFailureHandler(alertLoadFailure)
			.withSuccessHandler(loadData)
			.withUserObject(loadDataNumber)
			.getWebappDatabase();

		// event handlers
	}

	function loadData(database, loadDataNumber) {
		markProgress("Done", loadDataNumber);
		let parseDataNumber = markProgress("Parsing database");
		// any necessary validation or modification of database
		markProgress("Done", parseDataNumber);
		let prepareInterfaceNumber = markProgress("Preparing interface");
		resetPage("database");
		$("#content-loading").hide();
		$("#content-shadowland").show();
		markProgress("Done", prepareInterfaceNumber);
	}

	// reset the page settings and info for a given floor number, on the current
	// floor (if set to null or undefined), or from the database (if set
	// to anything that isNaN)
	function resetPage(floorNumber) {
		// we build and set the appropriate fields in turn

		// floor number
		var currentFloor = 0;
		if (floorNumber == null) {
			currentFloor = getCurrentFloor();
		} else if (isNaN(floorNumber)) {
			currentFloor = getCurrentFloor("database");
		} else {
			currentFloor = floorNumber;
		}
	}

	// returns the current floor number, determining it based on the
	// current page information if present, from the database if not or
	// if any NaN is given as the argument; this is *not* the same as
	// returning the number of the first uncompleted floor as previously
	// may have happened. If floorNumber is given and is a number,
	// throws an exception, as that's probably meant to be an attempt
	// to *set* the current floor number rather than obtain it. Finally,
	// in case we're not obtaining the number from the database, set the
	// sheet calculator to it for the next time we pull the database.
	function getCurrentFloor(floorNumber) {
		let currentFloor = 0;
		if (floorNumber == null) {
			// determine the floor number from the page
			// if unable to find, set to NaN
		} else if (isNaN(floorNumber)) {
			try {
				currentFloor = shadowlandDatabase[28][1];
			} catch (err) {
				currentFloor = 0;
			}
		} else {
			alertHalt("Improper use of getCurrentFloor( " + floorNumber + " )");
		}

		if (currentFloor < 1) {
			alertError(
				"Unable to determine current floor. Consider setting manually."
			);
		} else {
			saveFloorNumber(currentFloor);
			return currentFloor;
		}
	}

	function markProgress(text, jobNumber) {
		if (jobNumber == null) {
			// make job number
			// write text to log & progress bar
		} else {
			// try to find job based on job number
			// write text to log & progress bar
		}
		// return job number
	}

	// for issues that may not be right, but don't necessarily require user intervention
	function alertWarn(text) {
		alertError(text);
	}

	// for issues that require user intervention
	function alertError(text) {
		window.alert(text);
	}

	// for issues that are unrecoverable
	function alertHalt(text) {
		window.alert(text);
		throw new Error("Unrecoverable: " + text);
	}

	function logWarn(jobNumber) {
		alertWarn(
			"Job number " +
				jobNumber +
				" (" +
				getJobText(jobNumber) +
				") failed."
		);
	}

	function alertLoadFailure(error, userObj) {
		alertError(
			"Error loading the database: " + error.name + ": " + error.message
		);
	}

	function alertSaveFailure(error, userObj) {
		alertError(
			"Error saving the battle record: " +
				error.name +
				": " +
				error.message
		);
	}

	function getJobText(jobNumber) {
		// get the text associated with this jobNumber from the message queue
		return jobNumber;
	}

	function saveFloorNumber(floorNumber) {
		let jobNumber = markProgress("Saving current floor");
		google.script.run
			.withFailureHandler(logWarn)
			.withSuccessHandler(logSuccess)
			.withUserObject(jobNumber)
			.saveFloorNumber(floorNumber);
		return floorNumber;
	}
</script>
