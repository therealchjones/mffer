<script
	id="jquery-js"
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"
	crossorigin="anonymous"
></script>
<script
	id="bootstrap-js"
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
	crossorigin="anonymous"
></script>
<script id="mffer-js">
	"use strict";
	var shadowlandDatabase = null;
	var googlePicker = null;
	var googleOauthToken = null;
	var pickerApiKey = null;
	var settings = {
		oauthId: false,
		oauthSecret: false,
		pickerKey: false,
		authorization: false,
		spreadsheetId: false,
	};
	var importText = null;

	class Job {
		constructor(param) {
			let jobNumber = Math.floor(Math.random() * 10000);
		}
	}
	class JobQueue {}

	$(document).ready(function () {
		if ($("#mffer-spinner").length != 0) {
			$("#mffer-spinner").show();
		}
		if ($("#mffer-new").length != 0) {
			initializeSetup();
		} else {
			initializePage();
		}
	});
	function hasSetting(setting) {
		if (
			settings == null ||
			settings[setting] == null ||
			settings[setting] == false ||
			new String(settings[setting]).trim() == ""
		)
			return false;
		else return true;
	}
	function showLoading(message = null) {
		$("#loading-notes").text(message);
		$("#mffer-spinner").show();
	}
	function hideLoading() {
		$("#mffer-spinner").hide();
		$("#loading-notes").text(null);
	}

	function initializeSetup() {
		google.script.run
			.withFailureHandler(function () {
				throwError("Unable to obtain existing settings.");
			})
			.withSuccessHandler(checkSettings)
			.checkSettings();
		let buttons = $("#mffer-new button");
		buttons.click(function (event) {
			switch (event.currentTarget.id) {
				case "button-start-new-deployment":
					$("#mffer-new-intro").hide();
					createNewDeployment();
					break;
				case "button-api-key":
					// handled by the submit event handler
					break;
				case "button-choose-sheet":
					googlePicker.setVisible(true);
					break;
				case "button-upload-data":
					getNewData();
					break;
				default:
					throw "Invalid button pressed identifier";
					break;
			}
		});
		$("#mffer-new-keys").submit(function (event) {
			$("#mffer-new-get-keys").hide();
			showLoading("Saving credentials");
			event.preventDefault();
			let oauthId,
				oauthSecret,
				pickerKey = null;
			if (settings.oauthId == null || settings.oauthId == "") {
				oauthId = $("#input-oauth-id").val().trim();
			}
			if (settings.oauthSecret != true) {
				oauthSecret = $("#input-oauth-secret").val().trim();
			}
			if (settings.pickerKey != true) {
				pickerKey = $("#input-picker-key").val().trim();
			}
			$("#mffer-new-oauth-link").attr(
				"href",
				"https://console.cloud.google.com/apis/credentials/oauthclient/" +
					oauthId
			);
			google.script.run
				.withSuccessHandler(checkAuth)
				.withFailureHandler(function () {
					throw "Unable to set key properties";
				})
				.setKeyProperties(pickerKey, oauthId, oauthSecret);
		});
		$("#mffer-new").show();
	}
	function throwError(error) {
		$("#mffer-spinner h2").html("Error");
		let errorMessage =
			"<p>" +
			error +
			"</p><p>More information may be available in your browser's JavaScript console or in Google Scripts execution logs.</p>";
		$("#loading-notes").html(errorMessage);
		throw error;
	}
	function checkSettings(currentSettings) {
		if (currentSettings == null)
			throwError("Unable to get existing settings");
		settings = currentSettings;
		for (let setting in settings) {
			let settingString = new String(settings[setting]);
			markSetting(setting, settingString);
		}
		if (hasSetting("authorization") == true) getAuth(true);
		else if (
			hasSetting("oauthId") == true &&
			hasSetting("oauthSecret") == true &&
			hasSetting("pickerKey") == true
		)
			getAuth(false);
		else if (
			hasSetting("oauthId") == true ||
			hasSetting("oauthSecret") == true ||
			hasSetting("pickerKey") == true
		)
			createNewDeployment();
		else {
			$("#mffer-new-check-progress").hide();
			hideLoading();
			$("#mffer-new-intro").show();
		}
	}
	function markSetting(settingName, setting) {
		let checkBox = $("#mffer-new-progress-" + settingName);
		if (checkBox.length != 0) {
			if (setting == null || setting == false || setting.trim() == "") {
				checkBox.html("&#10060;");
			} else {
				checkBox.html("&#x2714;&#xfe0f;");
			}
		}
	}
	function createNewDeployment() {
		$("#mffer-new-check-progress").hide();
		showLoading("Checking existing configuration");
		let pickerKey = settings.pickerKey;
		if (!hasSetting("pickerKey")) {
			$("#input-picker-key").removeAttr("disabled").val("");
		} else {
			$("#input-picker-key").attr("disabled", "disabled").val("stored");
		}
		let oauthClientId = settings.oauthId;
		if (!hasSetting("oauthId")) {
			$("#input-oauth-id").removeAttr("disabled").val("");
		} else {
			$("#input-oauth-id").attr("disabled", "disabled").val("stored");
		}
		let oauthSecret = settings.oauthSecret;
		if (!hasSetting(oauthSecret)) {
			$("#input-oauth-secret").removeAttr("disabled").val("");
		} else {
			$("#input-oauth-secret").attr("disabled", "disabled").val("stored");
		}
		$("#mffer-new-get-keys").show();
	}
	function checkAuth() {
		showLoading("Checking authorizations");
		google.script.run
			.withSuccessHandler(getAuth)
			.withFailureHandler(function () {
				throwError(
					"Unable to get the status of current authorizations."
				);
			})
			.hasAdminAuthorization();
	}
	function getAuth(hasAccess) {
		$("#mffer-new-check-progress").hide();
		if (hasAccess == true) {
			showLoading("Getting current authorization");
			google.script.run
				.withSuccessHandler(loadPickerApi)
				.withFailureHandler(function () {
					throw "Unable to obtain current authorization";
				})
				.getAdminAuthToken();
		} else {
			showLoading("Getting new authorization");
			google.script.run
				.withSuccessHandler(presentAuth)
				.withFailureHandler(function () {
					throw "Unable to establish authentication service";
				})
				.getAuthUrl();
		}
	}
	function loadPickerApi(token) {
		if (token == null) throwError("Unable to obtain authorization.");
		googleOauthToken = token;
		showLoading("Loading Google Picker");
		$.getScript("https://apis.google.com/js/api.js")
			.done(function () {
				gapi.load("picker", accessGooglePicker);
			})
			.fail(function () {
				throw "Unable to load Google API";
			});
	}
	function presentAuth(authUrl) {
		if (authUrl == null) throw "No authorization link available";
		$("#mffer-auth-link").attr("href", authUrl);
		hideLoading();
		$("#mffer-new-get-authorization").show();
	}
	function accessGooglePicker() {
		google.script.run
			.withSuccessHandler(createGooglePicker)
			.withFailureHandler(function () {
				throwError("Unable to obtain Google Picker API Key");
			})
			.getPickerApiKey();
	}
	function createGooglePicker(apiKey) {
		if (apiKey != null) {
			pickerApiKey = apiKey;
		}
		let spreadsheetView = new google.picker.DocsView(
			google.picker.ViewId.SPREADSHEETS
		);
		spreadsheetView
			.setIncludeFolders(true)
			.setMode(google.picker.DocsView.LIST);
		let allFilesView = new google.picker.DocsView(
			google.picker.ViewId.DOCS
		);
		allFilesView
			.setIncludeFolders(true)
			.setMode(google.picker.DocsView.LIST);
		googlePicker = new google.picker.PickerBuilder()
			.addView(spreadsheetView)
			.addView(allFilesView)
			.hideTitleBar()
			.setOAuthToken(googleOauthToken)
			.setDeveloperKey(pickerApiKey)
			.setOrigin(google.script.host.origin)
			.setCallback(pickerCallback)
			.build();
		hideLoading();
		$("#mffer-new-get-database").show();
	}
	function pickerCallback(data) {
		if (
			data[google.picker.Response.ACTION] == google.picker.Action.PICKED
		) {
			if (
				data[google.picker.Response.DOCUMENTS] != null &&
				data[google.picker.Response.DOCUMENTS][0] != null
			) {
				$("#mffer-new-get-database").hide();
				showLoading("Checking file");
				google.host.run
					.withSuccessHandler(configComplete)
					.withFailureHandler(function () {
						throwError("Unable to use this file.");
					})
					.linkGoogleSheet(
						data[google.picker.Response.DOCUMENTS][0].ID
					);
			}
		}
	}
	function getNewData() {
		if ($("#mffer-filechooser").length == 1) {
			$("#mffer-filechooser button").click(function (event) {
				switch (event.target.id) {
					case "button-filechooser-confirm":
						$("#mffer-filechooser").hide();
						showLoading("Importing new data");
						google.script.run
							.withSuccessHandler(configComplete)
							.withFailureHandler(function () {
								throwError("Unable to import new data");
							})
							.importNewData(importText);
						break;
					case "button-filechooser-cancel":
						$("#input-filechooser").val(null);
						$("#input-filechooser").change();
						break;
					default:
						throwError("Unable to identify button clicked");
				}
			});
			$("#input-filechooser").change(function () {
				if (this.files != null && this.files.length != 0) {
					if (this.files.length > 1) {
						throwError(
							"Selection of multiple files is not supported."
						);
					}
					let file = this.files[0];
					let fileReader = new FileReader();
					fileReader.onload = function () {
						importText = fileReader.result;
						let headers = getFirstLines(importText);
						$("#mffer-filechooser-textdisplay").html(
							"<p>File preview:</p><pre>\n" + headers + "\n</pre>"
						);
						$("#mffer-filechooser-tabledisplay").html(
							csvToTable(headers)
						);
						$("#mffer-filechooser-pending").show();
					};
					fileReader.onerror = function () {
						throwError("Unable to read file");
					};
					fileReader.readAsText(file);
				} else $("#mffer-filechooser-pending").hide();
			});
			$("#mffer-new").hide();
			$("#mffer-filechooser").show();
		} else throwError("Unable to open the new file selector.");
	}
	function configComplete() {
		$("#mffer-new-url").hide();
		$("#mffer-new").children().hide();
		$("#mffer-filechooser").hide();
		hideLoading();
		$("#mffer-new-done").show();
		$("#mffer-new").show();
	}
	function initializePage() {
		$("#mffer-shadowland").hide();
		$("#mffer-spinner").show();

		let loadDataNumber = markProgress("Loading database");
		google.script.run
			.withFailureHandler(alertLoadFailure)
			.withSuccessHandler(loadData)
			.withUserObject(loadDataNumber)
			.getWebappDatabase();

		// event handlers
	}

	function loadData(database, loadDataNumber) {
		markProgress("Done", loadDataNumber);
		let parseDataNumber = markProgress("Parsing database");
		// any necessary validation or modification of database
		markProgress("Done", parseDataNumber);
		let prepareInterfaceNumber = markProgress("Preparing interface");
		resetPage("database");
		$("#content-loading").hide();
		$("#content-shadowland").show();
		markProgress("Done", prepareInterfaceNumber);
	}

	// reset the page settings and info for a given floor number, on the current
	// floor (if set to null or undefined), or from the database (if set
	// to anything that isNaN)
	function resetPage(floorNumber) {
		// we build and set the appropriate fields in turn

		// floor number
		var currentFloor = 0;
		if (floorNumber == null) {
			currentFloor = getCurrentFloor();
		} else if (isNaN(floorNumber)) {
			currentFloor = getCurrentFloor("database");
		} else {
			currentFloor = floorNumber;
		}
	}

	// returns the current floor number, determining it based on the
	// current page information if present, from the database if not or
	// if any NaN is given as the argument; this is *not* the same as
	// returning the number of the first uncompleted floor as previously
	// may have happened. If floorNumber is given and is a number,
	// throws an exception, as that's probably meant to be an attempt
	// to *set* the current floor number rather than obtain it. Finally,
	// in case we're not obtaining the number from the database, set the
	// sheet calculator to it for the next time we pull the database.
	function getCurrentFloor(floorNumber) {
		let currentFloor = 0;
		if (floorNumber == null) {
			// determine the floor number from the page
			// if unable to find, set to NaN
		} else if (isNaN(floorNumber)) {
			try {
				currentFloor = shadowlandDatabase[28][1];
			} catch (err) {
				currentFloor = 0;
			}
		} else {
			alertHalt("Improper use of getCurrentFloor( " + floorNumber + " )");
		}

		if (currentFloor < 1) {
			alertError(
				"Unable to determine current floor. Consider setting manually."
			);
		} else {
			saveFloorNumber(currentFloor);
			return currentFloor;
		}
	}

	function markProgress(text, jobNumber = null) {
		if (jobNumber == null) {
			// make job number
			// write text to log & progress bar
		} else {
			// try to find job based on job number
			// write text to log & progress bar
		}
		// return job number
	}

	// for issues that may not be right, but don't necessarily require user intervention
	function alertWarn(text) {
		alertError(text);
	}

	// for issues that require user intervention
	function alertError(text) {
		window.alert(text);
	}

	// for issues that are unrecoverable
	function alertHalt(text) {
		window.alert(text);
		throw new Error("Unrecoverable: " + text);
	}

	function logWarn(jobNumber) {
		alertWarn(
			"Job number " +
				jobNumber +
				" (" +
				getJobText(jobNumber) +
				") failed."
		);
	}

	function alertLoadFailure(error, userObj) {
		alertError(
			"Error loading the database: " + error.name + ": " + error.message
		);
	}

	function alertSaveFailure(error, userObj) {
		alertError(
			"Error saving the battle record: " +
				error.name +
				": " +
				error.message
		);
	}

	function getJobText(jobNumber) {
		// get the text associated with this jobNumber from the message queue
		return jobNumber;
	}

	function saveFloorNumber(floorNumber) {
		let jobNumber = markProgress("Saving current floor");
		google.script.run
			.withFailureHandler(logWarn)
			.withSuccessHandler(logSuccess)
			.withUserObject(jobNumber)
			.saveFloorNumber(floorNumber);
		return floorNumber;
	}
	function getFirstLines(text) {
		var maxDisplayLines = 3;
		var maxCharsPerLine = 140;
		var maxCharsTotal = 420;
		var i = 0;
		var startIndex = 0;
		var endIndex = 0;
		var returnText = "";
		var totalChars = text.length;
		while (i < maxDisplayLines) {
			i++;
			var nextNewLine = text.indexOf("\n", startIndex + 1);
			if (nextNewLine == -1) {
				endIndex = Math.min(startIndex + maxCharsPerLine, totalChars);
				returnText += text.substring(startIndex, endIndex);
				break;
			} else {
				endIndex = Math.min(startIndex + maxCharsPerLine, nextNewLine);
				returnText += text.substring(startIndex, endIndex);
				startIndex = nextNewLine;
			}
		}
		if (returnText.length > maxCharsTotal) {
			returnText = returnText.substring(0, maxCharsTotal);
		}
		return returnText;
	}
	function csvToTable(text) {
		google.script.run
			.withSuccessHandler(displayTable)
			.withFailureHandler(displayTableError)
			.csvToTable(text);
		return "<p>Parsing...</p>";
	}
	function displayTable(text) {
		$("#mffer-filechooser-tabledisplay").html(
			"<p>Sheet preview:</p>" + text
		);
	}
	function displayTableError(error) {
		$("#mffer-filechooser-tabledisplay").html(
			"<p>Parsing failed:</p>\n<p>" + error.message + "</p>"
		);
	}
</script>
